<script>
  const prompt = "Give me a single haunting line about the wind.";
  const out = document.getElementById("out");
  const es = new EventSource(`/stream?prompt=${encodeURIComponent(prompt)}`);

  // 1) Handle OpenAI's named events (what you're getting now)
  es.addEventListener("response.output_text.delta", (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (typeof msg.delta === "string") out.textContent += msg.delta;
    } catch {}
  });

  es.addEventListener("response.completed", () => {
    es.close();
    out.classList.remove("cursor");
  });

  // 2) Also handle default 'message' in case you later normalize the stream
  es.onmessage = (e) => {
    if (e.data === "[DONE]") { es.close(); out.classList.remove("cursor"); return; }
    try {
      const msg = JSON.parse(e.data);
      // If server ever sends plain { delta: "..." }
      if (typeof msg.delta === "string") out.textContent += msg.delta;
      if (msg.error) out.textContent += `\n[error] ${msg.error}`;
    } catch {
      // Non-JSON lines (rare)
    }
  };

  es.onerror = () => {
    out.classList.remove("cursor");
    out.textContent += "\n[stream error]";
    es.close();
  };
</script>
